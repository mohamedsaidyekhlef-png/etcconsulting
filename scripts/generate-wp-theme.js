import { execSync } from 'child_process';
import fs from 'fs';
import path from 'path';
import { fileURLToPath } from 'url';

const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);
const rootDir = path.join(__dirname, '..');

// Configuration
const THEME_NAME = 'et-consulting-hub';
const THEME_DIR = path.join(rootDir, THEME_NAME);
const BUILD_DIR = path.join(rootDir, 'dist');

console.log(`\nüöÄ Starting WordPress Theme Generation for ${THEME_NAME}...\n`);

// 1. Build the React App with the correct base path for WordPress
// We assume the theme will be installed in /wp-content/themes/et-consulting-hub/
console.log('üì¶ Building React Application...');
try {
  execSync(`vite build --base=/wp-content/themes/${THEME_NAME}/`, { stdio: 'inherit' });
} catch (error) {
  console.error('‚ùå Build failed:', error);
  process.exit(1);
}

// 2. Create Theme Directory
if (fs.existsSync(THEME_DIR)) {
  fs.rmSync(THEME_DIR, { recursive: true, force: true });
}
fs.mkdirSync(THEME_DIR);
fs.mkdirSync(path.join(THEME_DIR, 'assets'));

// 3. Copy Assets
console.log('üìÇ Copying assets...');
const assetsDir = path.join(BUILD_DIR, 'assets');
if (fs.existsSync(assetsDir)) {
  fs.cpSync(assetsDir, path.join(THEME_DIR, 'assets'), { recursive: true });
}

// 4. Generate style.css (Theme Metadata)
console.log('üìù Generating style.css...');
const styleCssContent = `/*
Theme Name: ET Consulting Hub
Theme URI: https://etconsultinghub.com
Author: ET Consulting
Author URI: https://etconsultinghub.com
Description: A premium, React-powered theme for ET Consulting Hub.
Version: 1.0.0
License: All rights reserved.
*/

/* 
   This theme uses a React application mounted on the root div.
   Styles are handled by the built CSS files in /assets.
*/
body {
    margin: 0;
    padding: 0;
    font-family: 'Inter', sans-serif;
    background-color: #F0FDF4; /* Soft White Fallback */
}
`;
fs.writeFileSync(path.join(THEME_DIR, 'style.css'), styleCssContent);

// 5. Generate functions.php (Asset Enqueuing)
console.log('üìù Generating functions.php...');
// We need to find the exact filenames generated by Vite (they contain hashes)
const assetFiles = fs.readdirSync(path.join(THEME_DIR, 'assets'));
const jsFile = assetFiles.find(f => f.endsWith('.js'));
const cssFile = assetFiles.find(f => f.endsWith('.css'));

const functionsPhpContent = `<?php
function et_consulting_scripts() {
    // Enqueue the main React build script
    wp_enqueue_script(
        'et-consulting-main',
        get_template_directory_uri() . '/assets/${jsFile}',
        array(),
        '1.0.0',
        true
    );

    // Enqueue the main styles
    wp_enqueue_style(
        'et-consulting-styles',
        get_template_directory_uri() . '/assets/${cssFile}',
        array(),
        '1.0.0'
    );

    // Pass data to React if needed (e.g., API URLs)
    wp_localize_script('et-consulting-main', 'wpData', array(
        'rootUrl' => get_site_url(),
        'themeUrl' => get_template_directory_uri()
    ));
}
add_action('wp_enqueue_scripts', 'et_consulting_scripts');

// Add module type to script tag for Vite compatibility
function et_add_type_attribute($tag, $handle, $src) {
    if ('et-consulting-main' !== $handle) {
        return $tag;
    }
    return '<script type="module" src="' . esc_url($src) . '"></script>';
}
add_filter('script_loader_tag', 'et_add_type_attribute', 10, 3);

// Support for Title Tag
add_theme_support('title-tag');
?>`;
fs.writeFileSync(path.join(THEME_DIR, 'functions.php'), functionsPhpContent);

// 6. Generate index.php (The App Shell)
console.log('üìù Generating index.php...');
const indexPhpContent = `<!DOCTYPE html>
<html <?php language_attributes(); ?>>
<head>
    <meta charset="<?php bloginfo( 'charset' ); ?>">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <!-- Preconnect for Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=Sora:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <?php wp_head(); ?>
</head>
<body <?php body_class(); ?>>
    <div id="root"></div>
    <?php wp_footer(); ?>
</body>
</html>`;
fs.writeFileSync(path.join(THEME_DIR, 'index.php'), indexPhpContent);

// 7. Generate screenshot.png placeholder (Optional but good for WP)
// We can't generate a real image easily, but we can skip it or copy one if available.
// For now, we skip it.

console.log(`
‚úÖ Theme Generation Complete!

üëâ NEXT STEPS:
1. Locate the folder: ${THEME_DIR}
2. Compress/Zip this folder named "et-consulting-hub".
3. Upload the zip file to WordPress (Appearance > Themes > Add New > Upload).
4. Activate the theme.
5. Ensure WordPress Permalinks are set to "Post name".
`);
